title: 小程序 一些笔记（一）
date: 2018/10/16
categories:
- 前端
- 小程序
tags:
- 小程序
comments: true
---

最近接触了一段时间小程序，记录了在开发过程中的一些结论

#### 小程序开发
1. [**小程序前后端交互过程**](https://www.jianshu.com/p/0b03cbb73e6f)
    - wx.login()获得code，传给后台服务器
    - 后台服务器请微信服务器请求，返回openId/sessionKey（用于获取用户已授权的其他数据，如运动步数）
    - 接着，后台生成一个xxcookie返回，把xxcookie:openId 键值形式存储在session，前端缓存（setStorageSync），每次请求携带xxcookie，后台就可以判断是哪个用户
    - 后台可以设置session 的时长，当用户放置打开的小程序几十分钟，session 是否失效
2. 用户授权过程
    - 授权窗口按确定
    ```
    <button  open-type='getUserInfo' bindgetuserinfo="getUserInfo">
        <text>微信授权</text>
    </button>
    
    getUserInfo: function(res) {
        xxxx
    }
    ```
3. 改变小程序每个页面或者单页面的背景色
    - 在app或者xx.wxss 加入，page 前面不用点
    ```
    page {
        background-color: #f4f4f4;
    }
    ```
4. [wx：key 在渲染中的作用](http://www.wxappclub.com/topic/536)
    - 当指定wx:key时，列表改变时（包括内容和顺序），渲染时只是重新排序各组件，而不用重新创建
    - key 要求唯一
    - key 对性能提高有好处
5. css :last-child，**循环四个元素，每一个元素都有底边框，但最后一个元素没有** 
    - 注意 xx:last-child 找到有共同父节点样式为xx 的元素
    - 再选定最后一个元素，该元素必须处在最后一位，且不能有其他不相关元素。
    - 复杂一点的形式：
    ```
    <view>
       <view class="xx">
          <text>tt</text>
          <view class='yy'>bb</view> 
       </view>
       
       <view class="xx">
          <text>tt</text>
          <view class='yy'>bb</view> 
       </view>
       
       <view class="xx">
          <text>tt</text>
          <view class='yy'>bb</view> 
       </view>
    <view>
    
    .xx .yy {
        border: 1rpx solid #a7a7a7;
        border-width: 0 0 1rpx 0;
    }
    
    .xx:last-child .yy {
        border-width: 0;
    }
    ```
7. [特别注意：js 的深拷贝问题](http://www.cnblogs.com/penghuwan/p/7359026.html)，引用相同的对象多次，且修改时，特别注意
   - 下面是我写的错误代码一部分，
   ```
    pId = {
        12: [{xx:'7', ...}],
        21: [{xx:'6', ...}],
        31: [{xx:'7', ...}]
    }
    starInfos = {
        6: [],
        7: []
    }
    
    let Activities = []
    for (let pId in posts) {
        let Activity = starInfos[posts[pId][0].xx]));

        Activity.like = posts[pId][0].like;

        Activities.push(Activity);
    };
   ```
   - Activity 实际上是多次引用了starInfos.7，并且对他进行修改，导致Activities 第1/3 元素相同，修改如下：
   ```
   
    let Activity = JSON.parse(JSON.stringify(starInfos[posts[pId][0].xx]))));
   ```
8. 小程序异步问题，**首页onLoad() 抢在app.js 的login 方法之前执行**
    - 封装代码方法，函数回调
    ```
    function waitFlag(signalOrigin, flag, status) {
        return new Promise(function(resolve, reject) {
            let i = 0
            let check = function() {
                if (!!signalOrigin[flag] === !!status) {
                    resolve()
                } else if (i++ > 1000) {
                    reject()
                } else {
                    setTimeout(check, 50)
                }
            }
            check()
        })
    }

    waitFlag.waitFlag(app.globalData, 'hasGet', true).then(() => {
        xxxxxx
    })
    ```
10. [修改js 对象，合并对象](http://www.cnblogs.com/penghuwan/p/7359026.html)
    - 修改对象
    ```
    let a = 'gender';
    let b = {
        name: 'lcs'
    }
    
    b[a] = 'boy'
    
    ```
    - Object.assign(target, source1, source2)
    ```
    aa = {
        name: 'lcs'
    }
    bb = {
        gender: 'boy'
    }
    Object.assign(aa, aa);
    
    aa = {
        name: 'lcs',
        gender: 'boy'
    }
    ```
9. 轮播图，图片，高度自适应(提前知道图片的WH，赋值给swiper)

    - 图片设置为 **懒加载**，否则加载过多图片手机迅速发烫
12. 点击图片放大功能
13. 视频图像得先下载，再保存到相册
14. 给图片添加水印，或者二维码（==建议后端来做：一条linux命令搞定==）
    - cavans 画图，加字
    - cavans 利用绝对定位隐藏，画图是visable: true
    - visable: false，导出图片到相册
13. ios 下video 出问题，无法部分视频

     - 设置 video 的custom-cache="{{false}}" 
16. <view> 绑定bindtap事件，**id/data-xx 传参**失效
    - 你点击的是子组件<text>
    - e.currentTarget.dataset/e.Target.dataset 的区别
    - 利用 e.currentTarget.dataset 可以
17. [图片加载时的占位图](https://juejin.im/post/5bae3a98f265da0aff17481b)
18. [视频不在可视范围，停止播放](https://juejin.im/post/5c4ee15cf265da61193c32f2)
```
ready() {
    // 在自定义组件内，一定要加上后面参数 this
    this.videoContext = wx.createVideoContext('swiperVideo', this)

    if (this.videoContext) {
        this.createIntersectionObserver().relativeToViewport({
            top: -100,
            bottom: -100
        }).observe('.swiper-video', (res) => {
            this.videoContext.pause();
        });
    }
}
```
19. [css 动画，不是瞬间变动，而是有个缓动效果](http://www.ruanyifeng.com/blog/2014/02/css_transition_and_animation.html)
    - 点击后，怎样很好的控制css，类似 xx:hover
    - 微信小程序 就用 hover-class ，view/button 支持

#### 自定义组件
1. 头像图片未加载成功之前显示占位图，利用bingload方法
```
<!--profile.wxml-->
<view class='v-h-center'>
    <image class="{{isFinishLoad ?'':'before-load'}}" bindtap='_event' src='{{imgSrc}}' bindload='finishLoad' />
</view>

<!--profile.js-->
finishLoad: function(){
    this.setData({
        isFinishLoad: true
    });
}

<!--profile.wxss-->
.before-load {
    margin-right: 40rpx;
    margin-left: 24rpx;
    width: 64rpx;
    height: 64rpx;
    border-radius: 50%;
    border: 1rpx solid #a7a7a7;
    background-color: #EEE;
}
```
2. 点击头象通知，触发父组件事件
```
<!--profile.js-->
_event: function(e){
    this.triggerEvent('XXX') 
}

<!--引用组件的页面.wxml-->
<profile bindXXX='xxx'  imgSrc='{{xxx}}' data-xx="{{xxx}}" />
```
#### css
学习到的一些css 属性
1. [box-shadow](https://developer.mozilla.org/zh-CN/docs/Web/CSS/box-shadow)
    - 阴影矩形会往上移动 1rpx
    ```
    /* x偏移量 | y偏移量 | 阴影模糊半径 | 阴影扩散半径 | 阴影颜色 */
    box-shadow: 2px 2px 2px 1px rgba(0, 0, 0, 0.2);
    
    <!-- 这个元素阴影盒子的偏移，正负含义类似 定位的left/top-->
    box-shadow: 0rpx -1rpx 0rpx 0rpx rgba(0, 0, 0, 0.15);
    ```
2. [box-shadow 详解](https://www.html.cn/archives/9360)

#### promise
1. 只关心自身逻辑，不关心结果处理。没有promise 你必须把网络请求success/fail 处理函数写在请求里面，反之，你可以把处理程序写在.then/.catch里面
2. 返回带有 网络请求结果的promise 对象
3. new promise().then() 会返回一个promise 对象，return 和 resolve 差不多一样效果，resovle 是执行成功的返回结果。
```

let a = return http.post(`/api/refresh.php`, data, true).then(res => {
        console.log("reflesh")
        console.log(res.data)
        console.log("reflesh")
        return res.data;
    })

a.then(res =>{
   // res 就是上面的res.data
})

<!--若改为-->

let a = return http.post(`/api/refresh.php`, data, true).then(res => {
        return new Promise(function(resolve, reject){
            resolve('lcs')
        });
    })
    
a.then(res)
    
```


欢迎大家给我留言，提建议，指出错误，一起讨论学习技术的感受！
